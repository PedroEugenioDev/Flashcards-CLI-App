import emojiRegex from "emoji-regex";
import { stripAnsi } from "./lib/ansi";
import { isFullwidthCodePoint } from "./lib/helpers";

export const stringWidth = (str: string) => {
  if (!str.length) return 0;
  str = str.replace(emojiRegex(), "  ");
  if (!str.length) return 0;

  str = stripAnsi(str);

  let width = 0;

  for (let i = 0; i < str.length; i++) {
    const code = str.codePointAt(i) || 0;

    // Ignore control characters
    if (code <= 0x1f || (code >= 0x7f && code <= 0x9f)) continue;

    // Ignore combining characters
    if (code >= 0x300 && code <= 0x36f) continue;

    // Surrogates
    if (code > 0xffff) i++;

    width += isFullwidthCodePoint(code) ? 2 : 1;
  }

  return width;
};

export default stringWidth;
